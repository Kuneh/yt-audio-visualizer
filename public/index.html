<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" href="favicon.svg" type="image/svg+xml">
    <title>YouTube Audio Visualizer</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;700&display=swap');

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Montserrat', sans-serif;
            background-color: #121212;
            color: #fff;
            margin: 0;
            padding: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            position: relative;
            overflow: hidden;
        }

        /* Animated Background */
        .background-animation {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            overflow: hidden;
        }

        .background-animation span {
            position: absolute;
            display: block;
            width: 20px;
            height: 20px;
            background: rgba(255, 0, 0, 0.2);
            animation: move 25s linear infinite;
            bottom: -150px;
            border-radius: 50%;
        }

        .background-animation span:nth-child(1) {
            left: 10%;
            width: 80px;
            height: 80px;
            animation-delay: 0s;
            animation-duration: 18s;
            background: rgba(138, 43, 226, 0.2);
        }

        .background-animation span:nth-child(2) {
            left: 20%;
            width: 30px;
            height: 30px;
            animation-delay: 2s;
            animation-duration: 12s;
            background: rgba(0, 191, 255, 0.2);
        }

        .background-animation span:nth-child(3) {
            left: 35%;
            width: 100px;
            height: 100px;
            animation-delay: 4s;
            animation-duration: 25s;
            background: rgba(255, 0, 255, 0.2);
        }

        .background-animation span:nth-child(4) {
            left: 50%;
            width: 150px;
            height: 150px;
            animation-delay: 0s;
            animation-duration: 15s;
            background: rgba(255, 69, 0, 0.2);
        }

        .background-animation span:nth-child(5) {
            left: 65%;
            width: 40px;
            height: 40px;
            animation-delay: 0s;
            animation-duration: 11s;
            background: rgba(124, 252, 0, 0.2);
        }

        .background-animation span:nth-child(6) {
            left: 75%;
            width: 110px;
            height: 110px;
            animation-delay: 3s;
            animation-duration: 22s;
            background: rgba(30, 144, 255, 0.2);
        }

        .background-animation span:nth-child(7) {
            left: 90%;
            width: 60px;
            height: 60px;
            animation-delay: 5s;
            animation-duration: 18s;
            background: rgba(255, 215, 0, 0.2);
        }

        @keyframes move {
            0% {
                transform: translateY(0) rotate(0deg);
                opacity: 0.8;
                border-radius: 0;
            }

            100% {
                transform: translateY(-1000px) rotate(720deg);
                opacity: 0;
                border-radius: 50%;
            }
        }

        .player-container {
            width: 100%;
            max-width: 800px;
            background-color: rgba(30, 30, 30, 0.85);
            border-radius: 16px;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.5);
            overflow: hidden;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .player-container:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.6);
        }

        .youtube-input {
            padding: 18px;
            background-color: rgba(37, 37, 37, 0.7);
            border-bottom: 1px solid #333;
        }

        .input-group {
            display: flex;
            gap: 10px;
        }

        input[type="text"] {
            flex-grow: 1;
            padding: 12px 18px;
            border-radius: 8px;
            border: 1px solid #333;
            background-color: rgba(15, 15, 15, 0.7);
            color: #fff;
            font-size: 16px;
            transition: all 0.3s ease;
            outline: none;
        }

        input[type="text"]:focus {
            border-color: #f00;
            box-shadow: 0 0 0 2px rgba(255, 0, 0, 0.2);
        }

        button {
            padding: 12px 24px;
            background: linear-gradient(135deg, #ff1b6b, #ff930f);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            transition: all 0.3s ease;
            outline: none;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(255, 0, 0, 0.3);
        }

        button:active {
            transform: translateY(1px);
        }

        .video-info {
            display: flex;
            padding: 18px;
            background-color: rgba(37, 37, 37, 0.7);
            border-bottom: 1px solid #333;
            opacity: 0;
            transform: translateY(20px);
            animation: fadeInUp 0.5s forwards;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .video-info:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            background-color: rgba(45, 45, 45, 0.9);
        }

        @keyframes fadeInUp {
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .thumbnail {
            width: 120px;
            height: 68px;
            border-radius: 8px;
            overflow: hidden;
            margin-right: 15px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .thumbnail:hover {
            transform: scale(1.05);
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.4);
        }

        .thumbnail img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: transform 0.5s ease;
        }

        .thumbnail:hover img {
            transform: scale(1.1);
        }

        .info-text {
            flex-grow: 1;
            transition: transform 0.3s ease;
        }

        .info-text:hover {
            transform: translateX(5px);
        }

        .info-text h3 {
            margin-bottom: 5px;
            color: #fff;
            transition: color 0.3s ease;
        }

        .info-text:hover h3 {
            color: #ff1b6b;
        }

        .info-text p {
            color: #aaa;
            transition: color 0.3s ease;
        }

        .info-text:hover p {
            color: #ff930f;
        }

        .visualization-container {
            width: 100%;
            height: 240px;
            background-color: #000;
            position: relative;
        }

        canvas {
            width: 100%;
            height: 100%;
            display: block;
        }

        .info-container {
            padding: 24px;
        }

        .song-title {
            font-size: 24px;
            margin: 0 0 5px 0;
            word-break: break-word;
            background: linear-gradient(90deg, #ff1b6b, #ff930f);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            transition: transform 0.3s ease;
        }

        .song-title:hover {
            transform: translateX(5px);
        }

        .artist {
            font-size: 18px;
            color: #aaa;
            margin: 0 0 24px 0;
            transition: transform 0.3s ease, color 0.3s ease;
        }

        .artist:hover {
            transform: translateX(5px);
            color: #ff930f;
        }

        .controls {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-top: 20px;
        }

        .play-button {
            background: linear-gradient(135deg, #ff1b6b, #ff930f);
            color: white;
            border: none;
            border-radius: 50%;
            width: 60px;
            height: 60px;
            font-size: 24px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 5px 15px rgba(255, 0, 0, 0.3);
            transition: all 0.3s ease;
        }

        .play-button:hover {
            transform: scale(1.1);
            box-shadow: 0 8px 25px rgba(255, 0, 0, 0.4);
        }

        .timeline {
            flex-grow: 1;
            margin: 0 20px;
            position: relative;
        }

        .progress-bar {
            height: 6px;
            background-color: #333;
            border-radius: 6px;
            overflow: hidden;
            cursor: pointer;
            position: relative;
        }

        .progress-bar:hover {
            height: 8px;
        }

        .progress {
            background: linear-gradient(90deg, #ff1b6b, #ff930f);
            height: 100%;
            width: 0;
            border-radius: 6px;
            position: relative;
            transition: width 0.1s ease-out;
        }

        .progress::after {
            content: '';
            position: absolute;
            right: -5px;
            top: -3px;
            width: 12px;
            height: 12px;
            background: #fff;
            border-radius: 50%;
            opacity: 0;
            transition: opacity 0.2s;
            box-shadow: 0 0 5px rgba(255, 255, 255, 0.8);
        }

        .progress-bar:hover .progress::after {
            opacity: 1;
        }

        .time-display {
            display: flex;
            justify-content: space-between;
            margin-top: 8px;
            font-size: 14px;
            color: #aaa;
        }

        .volume-container {
            display: flex;
            align-items: center;
        }

        .volume-icon {
            margin-right: 10px;
            cursor: pointer;
            transition: transform 0.3s ease;
            font-size: 18px;
        }

        .volume-icon:hover {
            transform: scale(1.2);
        }

        .volume-slider {
            width: 80px;
            cursor: pointer;
            -webkit-appearance: none;
            appearance: none;
            height: 4px;
            border-radius: 4px;
            background: #333;
            outline: none;
            transition: opacity 0.2s;
        }

        .volume-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #ff1b6b;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .volume-slider::-webkit-slider-thumb:hover {
            transform: scale(1.2);
            background: #ff930f;
        }

        .placeholder-text {
            text-align: center;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #444;
            font-size: 18px;
            width: 100%;
            padding: 0 20px;
        }

        /* Animated placeholder wave */
        .wave-container {
            position: absolute;
            top: 60%;
            left: 50%;
            transform: translateX(-50%);
            width: 70%;
            height: 40px;
        }

        .wave {
            height: 100%;
            width: 100%;
            position: relative;
        }

        .wave-bar {
            position: absolute;
            bottom: 0;
            width: 3px;
            height: 10px;
            background: linear-gradient(to top, #444, #222);
            animation: wave 1.2s infinite ease-in-out;
            border-radius: 6px;
        }

        @keyframes wave {

            0%,
            100% {
                height: 5px;
            }

            50% {
                height: 30px;
            }
        }

        /* Load multiple wave bars with different animations */
        .wave-bar:nth-child(1) {
            left: 0%;
            animation-delay: 0s;
        }

        .wave-bar:nth-child(2) {
            left: 5%;
            animation-delay: 0.1s;
        }

        .wave-bar:nth-child(3) {
            left: 10%;
            animation-delay: 0.2s;
        }

        .wave-bar:nth-child(4) {
            left: 15%;
            animation-delay: 0.3s;
        }

        .wave-bar:nth-child(5) {
            left: 20%;
            animation-delay: 0.4s;
        }

        .wave-bar:nth-child(6) {
            left: 25%;
            animation-delay: 0.5s;
        }

        .wave-bar:nth-child(7) {
            left: 30%;
            animation-delay: 0.6s;
        }

        .wave-bar:nth-child(8) {
            left: 35%;
            animation-delay: 0.5s;
        }

        .wave-bar:nth-child(9) {
            left: 40%;
            animation-delay: 0.4s;
        }

        .wave-bar:nth-child(10) {
            left: 45%;
            animation-delay: 0.3s;
        }

        .wave-bar:nth-child(11) {
            left: 50%;
            animation-delay: 0.2s;
        }

        .wave-bar:nth-child(12) {
            left: 55%;
            animation-delay: 0.3s;
        }

        .wave-bar:nth-child(13) {
            left: 60%;
            animation-delay: 0.4s;
        }

        .wave-bar:nth-child(14) {
            left: 65%;
            animation-delay: 0.5s;
        }

        .wave-bar:nth-child(15) {
            left: 70%;
            animation-delay: 0.6s;
        }

        .wave-bar:nth-child(16) {
            left: 75%;
            animation-delay: 0.5s;
        }

        .wave-bar:nth-child(17) {
            left: 80%;
            animation-delay: 0.4s;
        }

        .wave-bar:nth-child(18) {
            left: 85%;
            animation-delay: 0.3s;
        }

        .wave-bar:nth-child(19) {
            left: 90%;
            animation-delay: 0.2s;
        }

        .wave-bar:nth-child(20) {
            left: 95%;
            animation-delay: 0.1s;
        }

        /* Enhanced loading animation */
        .loading {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10;
            flex-direction: column;
        }

        .audio-loader {
            width: 80px;
            height: 60px;
            display: flex;
            justify-content: space-between;
            align-items: flex-end;
        }

        .audio-loader-bar {
            width: 8px;
            height: 15px;
            background: #fff;
            border-radius: 3px;
            animation: audio-wave 1.5s ease-in-out infinite;
        }

        .audio-loader-bar:nth-child(1) {
            background: linear-gradient(to top, #ff1b6b, #ff930f);
            animation-delay: 0.2s;
        }

        .audio-loader-bar:nth-child(2) {
            background: linear-gradient(to top, #ff930f, #ff1b6b);
            animation-delay: 0.4s;
        }

        .audio-loader-bar:nth-child(3) {
            background: linear-gradient(to top, #ff1b6b, #ff930f);
            animation-delay: 0.6s;
        }

        .audio-loader-bar:nth-child(4) {
            background: linear-gradient(to top, #ff930f, #ff1b6b);
            animation-delay: 0.8s;
        }

        .audio-loader-bar:nth-child(5) {
            background: linear-gradient(to top, #ff1b6b, #ff930f);
            animation-delay: 1s;
        }

        @keyframes audio-wave {
            0% {
                height: 10px;
            }

            50% {
                height: 45px;
            }

            100% {
                height: 10px;
            }
        }

        .loading-text {
            margin-top: 20px;
            color: #fff;
            font-size: 14px;
            letter-spacing: 1px;
            font-weight: 500;
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {

            0%,
            100% {
                opacity: 0.6;
            }

            50% {
                opacity: 1;
            }
        }

        .hidden {
            display: none;
        }

        /* Enhanced status message */
        .status-message {
            margin-top: 15px;
            padding: 10px 15px;
            border-radius: 8px;
            text-align: center;
            background-color: rgba(51, 51, 51, 0.8);
            transform: translateY(20px);
            animation: slideIn 0.3s forwards;
            position: relative;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        .status-message::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 3px;
            background: linear-gradient(90deg, transparent, #ff1b6b, #ff930f, transparent);
            animation: statusBar 3s linear infinite;
        }

        @keyframes statusBar {
            0% {
                left: -100%;
            }

            100% {
                left: 100%;
            }
        }

        @keyframes slideIn {
            to {
                transform: translateY(0);
            }
        }

        .error {
            background-color: rgba(255, 0, 0, 0.2);
            color: #ff6b6b;
            border-left: 4px solid #ff0000;
        }

        .error::before {
            background: linear-gradient(90deg, transparent, #ff0000, #ff4d4d, transparent);
        }

        .disclaimer {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 9999;
            background-color: rgba(30, 30, 30, 0.95);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            overflow-y: auto;
            padding: 20px;
            box-sizing: border-box;
        }

        .disclaimer h3 {
            margin-bottom: 1em;
            color: #ff930f;
            font-size: 1.5em;
        }

        .disclaimer p {
            max-width: 800px;
            margin-bottom: 1em;
            text-align: left;
            line-height: 1.6;
        }

        #closeDisclaimer {
            padding: 8px 16px;
            background: linear-gradient(135deg, #ff1b6b, #ff930f);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            transition: all 0.3s ease;
            outline: none;
            margin-top: 15px;
        }

        #closeDisclaimer:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(255, 0, 0, 0.3);
        }

        #closeDisclaimer:active {
            transform: translateY(1px);
        }

        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 9998;
            pointer-events: none;
        }
    </style>
</head>

<body>

    <div class="overlay" id="overlay"></div>

    <div class="background-animation">
        <span></span>
        <span></span>
        <span></span>
        <span></span>
        <span></span>
        <span></span>
        <span></span>
    </div>

    <div class="player-container">
        <div class="youtube-input">
            <div class="input-group">
                <input type="text" id="youtubeUrlInput" placeholder="Enter YouTube music URL">
                <button id="loadButton">Load</button>
            </div>
            <div id="statusMessage" class="status-message hidden"></div>
        </div>

        <div id="videoInfo" class="video-info hidden">
            <div class="thumbnail">
                <img id="thumbnailImg" src="" alt="Video thumbnail">
            </div>
            <div class="info-text">
                <h3 id="videoTitle"></h3>
                <p id="videoChannel"></p>
            </div>
        </div>

        <div class="visualization-container">
            <canvas id="canvas"></canvas>
            <div class="placeholder-text" id="placeholderText">
                Enter a YouTube URL above to visualize audio
                <div class="wave-container">
                    <div class="wave">
                        <div class="wave-bar"></div>
                        <div class="wave-bar"></div>
                        <div class="wave-bar"></div>
                        <div class="wave-bar"></div>
                        <div class="wave-bar"></div>
                        <div class="wave-bar"></div>
                        <div class="wave-bar"></div>
                        <div class="wave-bar"></div>
                        <div class="wave-bar"></div>
                        <div class="wave-bar"></div>
                        <div class="wave-bar"></div>
                        <div class="wave-bar"></div>
                        <div class="wave-bar"></div>
                        <div class="wave-bar"></div>
                        <div class="wave-bar"></div>
                        <div class="wave-bar"></div>
                        <div class="wave-bar"></div>
                        <div class="wave-bar"></div>
                        <div class="wave-bar"></div>
                        <div class="wave-bar"></div>
                    </div>
                </div>
            </div>
            <div id="loading" class="loading hidden">
                <div class="audio-loader">
                    <div class="audio-loader-bar"></div>
                    <div class="audio-loader-bar"></div>
                    <div class="audio-loader-bar"></div>
                    <div class="audio-loader-bar"></div>
                    <div class="audio-loader-bar"></div>
                </div>
                <div class="loading-text">Processing Audio...</div>
            </div>
        </div>

        <div class="info-container">
            <h2 class="song-title" id="songTitle">No song loaded</h2>
            <p class="artist" id="artist">Enter song URL above and then click the load button</p>

            <div class="timeline">
                <div class="progress-bar" id="progressBar">
                    <div class="progress" id="progress"></div>
                </div>
                <div class="time-display">
                    <span id="currentTime">0:00</span>
                    <span id="duration">0:00</span>
                </div>
            </div>

            <div class="controls">
                <button class="play-button" id="playButton">â–¶</button>

                <div class="volume-container">
                    <div class="volume-icon" id="volumeIcon">ðŸ”Š</div>
                    <input type="range" min="0" max="100" value="100" class="volume-slider" id="volumeSlider">
                </div>
            </div>
        </div>
    </div>

    <div class="disclaimer" id="disclaimer">
        <h3>Disclaimer</h3>
        <p>
            This project is intended for <strong>educational purposes only</strong>. It
            demonstrates how to work with web technologies like HTML5 Audio, Web Audio API, and
            server-side audio processing. It is not intended for widespread distribution or
            commercial use.
        </p>
        <p>
            Downloading and converting audio from YouTube videos may violate YouTube's Terms of
            Service. Users are solely responsible for ensuring they comply with all applicable
            terms and conditions, copyright laws, and other legal requirements. The developers of
            this project are not responsible for any misuse of this software.
        </p>
        <p>
            This project is not affiliated with, endorsed by, or sponsored by YouTube or Google.
            All trademarks and copyrights belong to their respective owners.
        </p>
        <p>
            Do not use this project to download or distribute copyrighted material without proper
            authorization. Respect the rights of content creators.
        </p>
        <button id="closeDisclaimer">Close</button>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const youtubeUrlInput = document.getElementById('youtubeUrlInput');
            const loadButton = document.getElementById('loadButton');
            const videoInfo = document.getElementById('videoInfo');
            const thumbnailImg = document.getElementById('thumbnailImg');
            const videoTitle = document.getElementById('videoTitle');
            const videoChannel = document.getElementById('videoChannel');
            const canvas = document.getElementById('canvas');
            const ctx = canvas.getContext('2d');
            const playButton = document.getElementById('playButton');
            const progressBar = document.getElementById('progressBar');
            const progress = document.getElementById('progress');
            const currentTime = document.getElementById('currentTime');
            const durationDisplay = document.getElementById('duration');
            const volumeSlider = document.getElementById('volumeSlider');
            const volumeIcon = document.getElementById('volumeIcon');
            const songTitle = document.getElementById('songTitle');
            const artist = document.getElementById('artist');
            const placeholderText = document.getElementById('placeholderText');
            const loading = document.getElementById('loading');
            const statusMessage = document.getElementById('statusMessage');
            const closeDisclaimerButton = document.getElementById('closeDisclaimer');
            const disclaimerDiv = document.getElementById('disclaimer');
            const overlayDiv = document.getElementById('overlay');

            let audio = new Audio();
            let isAudioLoaded = false;
            let currentVideoId = null;
            const sessionId = Date.now().toString();

            canvas.width = canvas.offsetWidth;
            canvas.height = canvas.offsetHeight;

            let audioContext;
            let analyser;
            let source;
            let dataArray;

            function showStatus(message, isError = false) {
                statusMessage.textContent = message;
                statusMessage.classList.remove('hidden');

                if (isError) {
                    statusMessage.classList.add('error');
                } else {
                    statusMessage.classList.remove('error');
                }

                if (!isError) {
                    setTimeout(() => {
                        statusMessage.classList.add('hidden');
                    }, 5000);
                }
            }

            function setLoading(isLoading) {
                if (isLoading) {
                    loading.classList.remove('hidden');
                } else {
                    loading.classList.add('hidden');
                }
            }

            function initAudio() {
                try {
                    if (!audioContext) {
                        audioContext = new(window.AudioContext || window.webkitAudioContext)();
                    }

                    if (source) {
                        source.disconnect();
                    }

                    analyser = audioContext.createAnalyser();
                    analyser.fftSize = 256;

                    source = audioContext.createMediaElementSource(audio);

                    source.connect(analyser);
                    analyser.connect(audioContext.destination);

                    dataArray = new Uint8Array(analyser.frequencyBinCount);

                } catch (error) {
                    showStatus("Error setting up visualizer: " + error.message, true);
                }
            }

            async function loadYoutubeAudio(url) {
                try {
                    setLoading(true);
                    showStatus("Fetching video information...");

                    const apiUrl = `http://localhost:3000/api/video-info?url=${encodeURIComponent(url)}`;

                    const infoResponse = await fetch(apiUrl);

                    if (!infoResponse.ok) {
                        const responseClone = infoResponse.clone();

                        try {
                            const errorData = await infoResponse.json();
                            throw new Error(errorData.error || 'Failed to get video info');
                        } catch (jsonError) {
                            const errorText = await responseClone.text();
                            throw new Error(`Server error (${infoResponse.status}): ${errorText.substring(0, 100)}...`);
                        }
                    }

                    const videoInfo = await infoResponse.json();
                    currentVideoId = videoInfo.videoId;

                    thumbnailImg.src = videoInfo.thumbnailUrl;
                    videoTitle.textContent = videoInfo.title;
                    videoChannel.textContent = videoInfo.author;
                    document.getElementById('videoInfo').classList.remove('hidden');

                    updateSongInfo(videoInfo.title, videoInfo.author);

                    showStatus("Downloading and converting audio...");

                    if (audioContext) {
                        if (source) {
                            try {
                                source.disconnect();
                            } catch (e) {}
                        }
                    }

                    audio.removeAttribute('src');
                    audio = new Audio();

                    audio.crossOrigin = "anonymous";

                    const audioUrl = `http://localhost:3000/api/stream-audio?url=${encodeURIComponent(url)}&sessionId=${sessionId}`;
                    audio.src = audioUrl;

                    audio.addEventListener('loadeddata', function() {
                        if (!isNaN(audio.duration)) {
                            durationDisplay.textContent = formatTime(audio.duration);
                        } else {
                            setTimeout(() => {
                                durationDisplay.textContent = formatTime(audio.duration);
                            }, 1000);
                        }
                    });

                    audio.addEventListener('loadstart', function() {
                        showStatus("Audio stream is starting...");
                    });

                    audio.addEventListener('waiting', function() {
                        showStatus("Buffering audio...");
                    });

                    audio.addEventListener('stalled', function() {
                        showStatus("Audio stream stalled, retrying...");
                    });

                    audio.addEventListener('canplay', function onCanPlay() {
                        isAudioLoaded = true;
                        setLoading(false);
                        placeholderText.style.display = "none";
                        showStatus("Audio ready to play");
                        audio.removeEventListener('canplay', onCanPlay);
                    });

                    audio.addEventListener('error', function(e) {
                        setLoading(false);
                        showStatus(`Error loading audio: ${audio.error ? audio.error.message : "unknown error"}`, true);
                    });

                } catch (error) {
                    setLoading(false);
                    showStatus(error.message || "Error loading YouTube video", true);
                }
            }

            loadButton.addEventListener('click', function() {
                const url = youtubeUrlInput.value.trim();

                if (url) {
                    if (isAudioLoaded) {
                        audio.pause();
                        playButton.textContent = 'â–¶';
                    }

                    loadYoutubeAudio(url);
                } else {
                    showStatus("Please enter a YouTube URL", true);
                }
            });

            youtubeUrlInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    loadButton.click();
                }
            });

            function updateSongInfo(title, artistName) {
                songTitle.textContent = title;
                artist.textContent = artistName;
            }

            function formatTime(seconds) {
                if (isNaN(seconds)) return "0:00";
                const mins = Math.floor(seconds / 60);
                const secs = Math.floor(seconds % 60);
                return `${mins}:${secs < 10 ? '0' : ''}${secs}`;
            }

            function updateProgress() {
                if (isAudioLoaded && !isNaN(audio.duration)) {
                    const percent = (audio.currentTime / audio.duration) * 100;
                    progress.style.width = `${percent}%`;
                    currentTime.textContent = formatTime(audio.currentTime);
                }
            }

            let visualizationStartTime = 0;
            let initialDelayComplete = false;

            function drawVisualization() {
                requestAnimationFrame(drawVisualization);

                if (!dataArray || audio.paused || !isAudioLoaded) {
                    ctx.fillStyle = '#000';
                    ctx.fillRect(0, 0, canvas.width, canvas.height);

                    const centerY = canvas.height / 2;
                    const amplitude = 30;
                    const frequency = 0.05;
                    const numPoints = canvas.width;

                    ctx.beginPath();
                    ctx.moveTo(0, centerY);

                    for (let x = 0; x < numPoints; x++) {
                        const y = centerY + Math.sin(x * frequency) * amplitude;
                        ctx.lineTo(x, y);
                    }

                    ctx.strokeStyle = '#333';
                    ctx.lineWidth = 2;
                    ctx.stroke();

                    initialDelayComplete = false;
                    visualizationStartTime = 0;

                    return;
                }

                if (!initialDelayComplete) {
                    if (visualizationStartTime === 0) {
                        visualizationStartTime = Date.now();
                        return;
                    }

                    const elapsedTime = Date.now() - visualizationStartTime;
                    const delayDuration = 500;

                    if (elapsedTime < delayDuration) {
                        return;
                    } else {
                        initialDelayComplete = true;
                    }
                }

                try {
                    analyser.getByteFrequencyData(dataArray);

                    ctx.fillStyle = '#000';
                    ctx.fillRect(0, 0, canvas.width, canvas.height);

                    const barWidth = canvas.width / analyser.frequencyBinCount;
                    let x = 0;

                    for (let i = 0; i < analyser.frequencyBinCount; i++) {
                        const barHeight = dataArray[i] / 255 * canvas.height;

                        const gradient = ctx.createLinearGradient(0, canvas.height, 0, 0);
                        gradient.addColorStop(0, '#f00');
                        gradient.addColorStop(0.5, '#ff0');
                        gradient.addColorStop(1, '#0f0');

                        ctx.fillStyle = gradient;
                        ctx.fillRect(x, canvas.height - barHeight, barWidth - 1, barHeight);

                        x += barWidth;
                    }
                } catch (e) {}
            }

            function startProgressMonitor() {
                const progressInterval = setInterval(() => {
                    if (audio && !audio.paused && isAudioLoaded) {
                        updateProgress();
                    }
                }, 250);

                audio.addEventListener('ended', () => {
                    clearInterval(progressInterval);
                });

                loadButton.addEventListener('click', () => {
                    clearInterval(progressInterval);
                });
            }

            playButton.addEventListener('click', function() {
                if (!isAudioLoaded) {
                    showStatus("Please load a YouTube video first", true);
                    return;
                }

                if (audio.paused) {
                    if (!source || !analyser) {
                        initAudio();
                    }

                    if (audioContext && audioContext.state === 'suspended') {
                        audioContext.resume();
                    }

                    audio.play().then(() => {
                        playButton.textContent = 'âšâš';
                        placeholderText.style.display = "none";

                        startProgressMonitor();
                    }).catch(e => {
                        showStatus("Unable to play audio: " + e.message, true);
                    });
                } else {
                    audio.pause();
                    playButton.textContent = 'â–¶';
                }
            });

            volumeSlider.addEventListener('input', function() {
                audio.volume = this.value / 100;

                if (audio.volume === 0) {
                    volumeIcon.textContent = 'ðŸ”‡';
                } else if (audio.volume < 0.5) {
                    volumeIcon.textContent = 'ðŸ”‰';
                } else {
                    volumeIcon.textContent = 'ðŸ”Š';
                }
            });

            volumeIcon.addEventListener('click', function() {
                if (audio.volume > 0) {
                    audio.volume = 0;
                    volumeSlider.value = 0;
                    volumeIcon.textContent = 'ðŸ”‡';
                } else {
                    audio.volume = 1;
                    volumeSlider.value = 100;
                    volumeIcon.textContent = 'ðŸ”Š';
                }
            });

            progressBar.addEventListener('click', function(e) {
                if (!isAudioLoaded) return;

                const percent = e.offsetX / this.offsetWidth;
                audio.currentTime = percent * audio.duration;
                updateProgress();
            });

            audio.addEventListener('loadedmetadata', function() {
                if (!isNaN(audio.duration)) {
                    durationDisplay.textContent = formatTime(audio.duration);
                }
            });

            audio.addEventListener('durationchange', function() {
                durationDisplay.textContent = formatTime(audio.duration);
            });

            audio.addEventListener('timeupdate', updateProgress);

            audio.addEventListener('seeking', function() {});

            audio.addEventListener('ended', function() {
                playButton.textContent = 'â–¶';
                progress.style.width = '0%';
                currentTime.textContent = '0:00';
            });

            window.addEventListener('resize', function() {
                canvas.width = canvas.offsetWidth;
                canvas.height = canvas.offsetHeight;
            });

            window.addEventListener('beforeunload', function() {
                navigator.sendBeacon(
                    'http://localhost:3000/api/cleanup',
                    JSON.stringify({
                        sessionId
                    })
                );
            });

            closeDisclaimerButton.addEventListener('click', function() {
                disclaimerDiv.style.display = 'none';
                overlayDiv.style.display = 'none'; // Hide the overlay too
            });

            drawVisualization();
        });
    </script>
</body>

</html>